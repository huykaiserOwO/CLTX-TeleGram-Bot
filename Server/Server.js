const express = require('express')
const { createServer } = require('http')
const path = require('path')
const { Server } = require('socket.io')
const app = express()
const httpServer = createServer(app)
const mysql = require('mysql')
var fs = require('fs')
var request = require('request')
var DB = require('./Config/DB')

const port = 8000

// Socket Io
const io = new Server(httpServer, {
    cors: "http://127.0.0.1:8000"

})

var conn = DB.ConnectToDataBase()

// Game B√†n T√†i X·ªâu
const GameTaiXiu = function () {

    // c√†i ƒë·∫∑t
    this.idPhien = 0;  // id phi√™n ƒë·∫∑t
    this.TimeInit = ''; // Th·ªùi gian kh·ªüi t·∫°o
    this.timeDatCuoc = 60; // th·ªùi gian ƒë·∫∑t c∆∞·ª£c = 60s;
    this.timechophienmoi = 20; // th·ªùi gian ch·ªù phi√™n m·ªõi = 10s;
    this.soNguoiChonTai = 0;  // S·ªë ng∆∞·ªùi ƒë·∫∑t t√†i
    this.soNguoiChonXiu = 0;  // S·ªë ng∆∞·ªùi ƒë·∫∑t x·ªâu
    this.tongTienDatTai = 0;  // t·ªïng ti·ªÅn ƒë·∫∑t t√†i
    this.tongTienDatXiu = 0;  // t·ªïng ti·ªÅn ƒë·∫∑t x·ªâu
    this.time;  // th·ªùi gian
    this.coTheDatCuoc = true; // c√≥ th·ªÉ ƒë·∫∑t hay kh√¥ng
    this.idChonTai = []; // array id ch·ªçn t√†i
    this.idChonXiu = []; // array id ch·ªçn x·ªâu
    this.ketQua = ''; // k·∫øt qu·∫£

    // game b·∫Øt ƒë·∫ßu
    this.gameStart = function () {

        // M·ªü ƒë·∫∑t c∆∞·ª£c
        var Sql = 'DELETE FROM blockcuocbantaixiu'
        conn.query(Sql, function (err) {
            if (err) throw err
        })
        // code
        seft = this;
        seft.ketQua = '';
        seft.TimeInit = user.TimeCurrent()
        seft.idPhien = seft.RandomNumber(5);
        seft.coTheDatCuoc = true // c√≥ th·ªÉ ƒë·∫∑t
        seft.soNguoiChonTai = 0;  // S·ªë ng∆∞·ªùi ƒë·∫∑t t√†i
        seft.soNguoiChonXiu = 0;  // S·ªë ng∆∞·ªùi ƒë·∫∑t x·ªâu
        seft.tongTienDatTai = 0;  // t·ªïng ti·ªÅn ƒë·∫∑t t√†i
        seft.tongTienDatXiu = 0;  // t·ªïng ti·ªÅn ƒë·∫∑t x·ªâu
        seft.idChonTai = []; // array id ch·ªçn t√†i
        seft.idChonXiu = []; // array id ch·ªçn x·ªâu
        seft.time = seft.timeDatCuoc;
        console.log('newgame');
        io.sockets.emit('gameStart', this.ketQua);
        // L∆∞u ƒëo·∫°n chat 
        var Mess = "Id phi√™n: " + seft.idPhien + ", phi√™n ƒëang di·ªÖn ra..."
        Sql = "INSERT INTO chat (Nickname,TimeInit,IdNguoiGui,IdNguoiNhan,Mess) VALUES (?,?,?,?,?)"
        conn.query(Sql, ['', seft.TimeInit, 'System', 'All', Mess], function (err) {
            if (err) throw err
            user.SendChat()
        })


        // D·ª± ƒë·ªãnh ƒë·ªï x√∫c x·∫Øc 
        this.ketQua = this.gameRandomResult()

        loopAGame = setInterval(function () {
            seft.time--;
            io.sockets.emit('gameData', {
                TimeInit: seft.TimeInit,
                idGame: seft.idPhien,
                soNguoiChonTai: seft.soNguoiChonTai,
                soNguoiChonXiu: seft.soNguoiChonXiu,
                tongTienDatTai: seft.tongTienDatTai,
                tongTienDatXiu: seft.tongTienDatXiu,
                time: seft.time,
                Msg: 'Phi√™n ƒëang di·ªÖn ra'
            });
            io.to('LIXI66TOP').emit('DuDinhKetQua', seft.ketQua)
            console.log(
                'D·ª± ƒë·ªãnh ƒë·ªï x√∫c x·∫Øc: ' + seft.ketQua.dice1 + ' | ' + seft.ketQua.dice2 + ' | '
                + seft.ketQua.dice3 + ' | ' + seft.ketQua.result
            )
            console.log('th·ªùi gian kh·ªüi t·∫°o: ' + seft.TimeInit)
            console.log('Phi√™n: ' + seft.idPhien);
            console.log('S·ªë ng∆∞·ªùi ch·ªçn t√†i: ' + seft.soNguoiChonTai);
            console.log('S·ªë ng∆∞·ªùi ch·ªçn x·ªâu: ' + seft.soNguoiChonXiu);
            console.log('T·ªïng ti·ªÅn ƒë·∫∑t t√†i: ' + seft.tongTienDatTai);
            console.log('T·ªïng ti·ªÅn ƒë·∫∑t x·ªâu: ' + seft.tongTienDatXiu);
            console.log('time: ' + seft.time);
            if (seft.time == 0) {
                clearInterval(loopAGame);
                seft.gameOver();
            }
        }, 1000);

    };


    // game k·∫øt th√∫c
    this.gameOver = function () {
        seft = this;
        seft.coTheDatCuoc = false // kh√¥ng th·ªÉ ƒë·∫∑t
        // Ch·∫∑n ƒë·∫∑t c∆∞·ª£c
        var Sql = "INSERT INTO blockcuocbantaixiu (On_Off) VALUES ('On')"
        conn.query(Sql, function (err) {
            if (err) throw err
        })
        seft.time = seft.timechophienmoi;
        io.sockets.emit('gameOver', this.ketQua);
        console.log(JSON.stringify(this.ketQua));
        var Win = seft.ketQua.result == 'tai' ? seft.idChonTai : seft.idChonXiu
        console.log('S·ªë ng∆∞·ªùi th·∫Øng c∆∞·ª£c: ' + Win.length)

        if (seft.ketQua.result === 'tai') {
            if (seft.idChonTai != '') {
                for (var x in seft.idChonTai) {

                    // Tr·∫£ th∆∞·ªüng 
                    var WinAmount = Number((seft.idChonTai)[x]['TienCuoc']) * Number((seft.idChonTai[x]['TiLe']))
                    var UpdateWalletUser = WinAmount + Number((seft.idChonTai[x]['Vi']))
                    Sql = "UPDATE user SET Wallet = ? WHERE IdTelegram = ?"
                    conn.query(Sql, [UpdateWalletUser, (seft.idChonTai)[x]['IdTelegram']], function (err) {
                        if (err) throw err
                    })

                    // L∆∞u th·ªëng k√™ ng∆∞·ªùi ch∆°i
                    Sql = "SELECT * FROM thongkenguoichoi WHERE IdTelegram = ?"
                    conn.query(Sql, [(seft.idChonTai)[x]['IdTelegram']], function (err, data) {
                        if (err) throw err
                        if (data != '') {
                            var TongTienCuoc = Number(data[0]['TongTienCuoc']) + Number((seft.idChonTai)[x]['TienCuoc'])
                            var TongTienThangCuoc = Number(data[0]['TongTienThangCuoc']) + (WinAmount - Number((seft.idChonTai)[x]['TienCuoc']))
                            var SoLanChoi = Number(data[0]['SoLanChoi']) + 1
                            Sql = "UPDATE thongkenguoichoi SET TongTienCuoc = ?, TongTienThangCuoc = ?, SoLanChoi = ? WHERE IdTelegram = ?"
                            conn.query(Sql, [TongTienCuoc, TongTienThangCuoc, SoLanChoi, (seft.idChonTai)[x]['IdTelegram']], function (err) {
                                if (err) throw err
                            })

                        }
                        else if (data == '') {
                            var TongTienCuoc = Number((seft.idChonTai)[x]['TienCuoc'])
                            var TongTienThangCuoc = WinAmount - Number((seft.idChonTai)[x]['TienCuoc'])
                            var SoLanChoi = 1
                            Sql = "INSERT INTO thongkenguoichoi (IdTelegram,Nickname,TongTienCuoc,TongTienThangCuoc,SoLanChoi) VALUES (?,?,?,?,?)"
                            conn.query(Sql, [
                                (seft.idChonTai)[x]['IdTelegram'],
                                (seft.idChonTai)[x]['Nickname'],
                                TongTienCuoc,
                                TongTienThangCuoc,
                                SoLanChoi
                            ],
                                function (err) {
                                    if (err) throw err
                                })
                        }
                    })

                    // X√≥a ƒë∆°n c∆∞·ª£c b√†n t√†i x·ªâu
                    Sql = "DELETE FROM doncuocbantaixiu WHERE IdTelegram = ?"
                    conn.query(Sql, [(seft.idChonTai)[x]['IdTelegram']], function (err) {
                        if (err) throw err
                    })

                    // L∆∞u l·ªãch s·ª≠ ch∆°i
                    Sql = "INSERT INTO gamehistory (TimeInit,IdTelegram,Nickname,TroChoi,DaChon,SoTien,KetQua,KetQua1,TraThuong,SaoKe,GhiChu) VALUES (?,?,?,?,?,?,?,?,?,?,?)"
                    conn.query(Sql, [
                        (seft.idChonTai)[x]['TimeInit'],
                        (seft.idChonTai)[x]['IdTelegram'],
                        (seft.idChonTai)[x]['Nickname'],
                        'B√†n T√†i X·ªâu',
                        (seft.idChonTai)[x]['Cau'],
                        (seft.idChonTai)[x]['TienCuoc'],
                        seft.ketQua.result,
                        'Win',
                        (WinAmount - Number((seft.idChonTai)[x]['TienCuoc'])),
                        Number(seft.idChonTai[x]['Vi']),
                        (String((seft.idChonTai)[x]['Cau']) + ' ' + String((seft.idChonTai)[x]['TienCuoc']))

                    ], function (err) {
                        if (err) throw err
                    })

                    // G·ª≠i t·ªõi tele
                    var Text = "LIXI66.TOP\n\nüéÆ Id phi√™n game: " + seft.idPhien + "\nüé≤ X√∫c x·∫Øc ƒë·ªï v·ªÅ t√†i\nüèÜ Ch√∫c m·ª´ng b·∫°n th·∫Øng c∆∞·ª£c"
                    this.SEND((seft.idChonTai)[x]['IdTelegram'], Text)

                    user.GameHistoryUser((seft.idChonTai)[x]['IdTelegram'])
                    user.DonCuocBanTaiXiu((seft.idChonTai)[x]['IdTelegram'])

                }

            }

            if (seft.idChonXiu != '') {
                for (var x in seft.idChonXiu) {

                    // L∆∞u th·ªëng k√™ ng∆∞·ªùi ch∆°i
                    Sql = "SELECT * FROM thongkenguoichoi WHERE IdTelegram = ?"
                    conn.query(Sql, [(seft.idChonXiu)[x]['IdTelegram']], function (err, data) {
                        if (err) throw err
                        if (data != '') {
                            var TongTienCuoc = Number(data[0]['TongTienCuoc']) + Number((seft.idChonXiu)[x]['TienCuoc'])
                            var TongTienThangCuoc = Number(data[0]['TongTienThangCuoc']) + (0 - Number((seft.idChonXiu)[x]['TienCuoc']))
                            var SoLanChoi = Number(data[0]['SoLanChoi']) + 1
                            Sql = "UPDATE thongkenguoichoi SET TongTienCuoc = ?, TongTienThangCuoc = ?, SoLanChoi = ? WHERE IdTelegram = ?"
                            conn.query(Sql, [TongTienCuoc, TongTienThangCuoc, SoLanChoi, (seft.idChonXiu)[x]['IdTelegram']], function (err) {
                                if (err) throw err
                            })

                        }
                        else if (data == '') {
                            var TongTienCuoc = Number((seft.idChonXiu)[x]['TienCuoc'])
                            var TongTienThangCuoc = 0 - Number((seft.idChonXiu)[x]['TienCuoc'])
                            var SoLanChoi = 1
                            Sql = "INSERT INTO thongkenguoichoi (IdTelegram,Nickname,TongTienCuoc,TongTienThangCuoc,SoLanChoi) VALUES (?,?,?,?,?)"
                            conn.query(Sql, [
                                (seft.idChonXiu)[x]['IdTelegram'],
                                (seft.idChonXiu)[x]['Nickname'],
                                TongTienCuoc,
                                TongTienThangCuoc,
                                SoLanChoi
                            ],
                                function (err) {
                                    if (err) throw err
                                })

                        }

                    })

                    // X√≥a ƒë∆°n c∆∞·ª£c b√†n t√†i x·ªâu
                    Sql = "DELETE FROM doncuocbantaixiu WHERE IdTelegram = ?"
                    conn.query(Sql, [(seft.idChonXiu)[x]['IdTelegram']], function (err) {
                        if (err) throw err
                    })



                    // L∆∞u l·ªãch s·ª≠ ch∆°i
                    Sql = "INSERT INTO gamehistory (TimeInit,IdTelegram,Nickname,TroChoi,DaChon,SoTien,KetQua,KetQua1,TraThuong,SaoKe,GhiChu) VALUES (?,?,?,?,?,?,?,?,?,?,?)"
                    conn.query(Sql, [
                        (seft.idChonXiu)[x]['TimeInit'],
                        (seft.idChonXiu)[x]['IdTelegram'],
                        (seft.idChonXiu)[x]['Nickname'],
                        'B√†n T√†i X·ªâu',
                        (seft.idChonXiu)[x]['Cau'],
                        (seft.idChonXiu)[x]['TienCuoc'],
                        seft.ketQua.result,
                        'Losing',
                        (0 - Number((seft.idChonXiu)[x]['TienCuoc'])),
                        Number(seft.idChonXiu[x]['Vi']),
                        (String((seft.idChonXiu)[x]['Cau']) + ' ' + String((seft.idChonXiu)[x]['TienCuoc']))

                    ], function (err) {
                        if (err) throw err
                    })


                    // G·ª≠i t·ªõi tele
                    var Text = "LIXI66.TOP\n\nüéÆ Id phi√™n game: " + seft.idPhien + "\nüé≤ X√∫c x·∫Øc ƒë·ªï v·ªÅ t√†i\nüçÄ V√°n sau c√≥ th·ªÉ may m·∫Øn n√® !"
                    this.SEND((seft.idChonXiu)[x]['IdTelegram'], Text)

                    user.GameHistoryUser((seft.idChonXiu)[x]['IdTelegram'])
                    user.DonCuocBanTaiXiu((seft.idChonXiu)[x]['IdTelegram'])
                }
            }
        }
        else {
            if (seft.idChonXiu != '') {
                for (var x in seft.idChonXiu) {

                    // Tr·∫£ th∆∞·ªüng 
                    var WinAmount = Number((seft.idChonXiu)[x]['TienCuoc']) * Number((seft.idChonXiu[x]['TiLe']))
                    var UpdateWalletUser = WinAmount + Number((seft.idChonXiu[x]['Vi']))
                    Sql = "UPDATE user SET Wallet = ? WHERE IdTelegram = ?"
                    conn.query(Sql, [UpdateWalletUser, (seft.idChonXiu)[x]['IdTelegram']], function (err) {
                        if (err) throw err
                    })

                    // L∆∞u th·ªëng k√™ ng∆∞·ªùi ch∆°i
                    Sql = "SELECT * FROM thongkenguoichoi WHERE IdTelegram = ?"
                    conn.query(Sql, [(seft.idChonXiu)[x]['IdTelegram']], function (err, data) {
                        if (err) throw err
                        if (data != '') {
                            var TongTienCuoc = Number(data[0]['TongTienCuoc']) + Number((seft.idChonXiu)[x]['TienCuoc'])
                            var TongTienThangCuoc = Number(data[0]['TongTienThangCuoc']) + (WinAmount - Number((seft.idChonXiu)[x]['TienCuoc']))
                            var SoLanChoi = Number(data[0]['SoLanChoi']) + 1
                            Sql = "UPDATE thongkenguoichoi SET TongTienCuoc = ?, TongTienThangCuoc = ?, SoLanChoi = ? WHERE IdTelegram = ?"
                            conn.query(Sql, [TongTienCuoc, TongTienThangCuoc, SoLanChoi, (seft.idChonXiu)[x]['IdTelegram']], function (err) {
                                if (err) throw err
                            })

                        }
                        else if (data == '') {
                            var TongTienCuoc = Number((seft.idChonXiu)[x]['TienCuoc'])
                            var TongTienThangCuoc = WinAmount - Number((seft.idChonXiu)[x]['TienCuoc'])
                            var SoLanChoi = 1
                            Sql = "INSERT INTO thongkenguoichoi (IdTelegram,Nickname,TongTienCuoc,TongTienThangCuoc,SoLanChoi) VALUES (?,?,?,?,?)"
                            conn.query(Sql, [
                                (seft.idChonXiu)[x]['IdTelegram'],
                                (seft.idChonXiu)[x]['Nickname'],
                                TongTienCuoc,
                                TongTienThangCuoc,
                                SoLanChoi
                            ],
                                function (err) {
                                    if (err) throw err
                                })
                        }
                    })

                    // X√≥a ƒë∆°n c∆∞·ª£c b√†n t√†i x·ªâu
                    Sql = "DELETE FROM doncuocbantaixiu WHERE IdTelegram = ?"
                    conn.query(Sql, [(seft.idChonXiu)[x]['IdTelegram']], function (err) {
                        if (err) throw err
                    })

                    // L∆∞u l·ªãch s·ª≠ ch∆°i
                    Sql = "INSERT INTO gamehistory (TimeInit,IdTelegram,Nickname,TroChoi,DaChon,SoTien,KetQua,KetQua1,TraThuong,SaoKe,GhiChu) VALUES (?,?,?,?,?,?,?,?,?,?,?)"
                    conn.query(Sql, [
                        (seft.idChonXiu)[x]['TimeInit'],
                        (seft.idChonXiu)[x]['IdTelegram'],
                        (seft.idChonXiu)[x]['Nickname'],
                        'B√†n T√†i X·ªâu',
                        (seft.idChonXiu)[x]['Cau'],
                        (seft.idChonXiu)[x]['TienCuoc'],
                        seft.ketQua.result,
                        'Win',
                        (WinAmount - Number((seft.idChonXiu)[x]['TienCuoc'])),
                        Number(seft.idChonXiu[x]['Vi']),
                        (String((seft.idChonXiu)[x]['Cau']) + ' ' + String((seft.idChonXiu)[x]['TienCuoc']))

                    ], function (err) {
                        if (err) throw err
                    })

                    // G·ª≠i t·ªõi tele
                    var Text = "LIXI66.TOP\n\nüéÆ Id phi√™n game: " + seft.idPhien + "\nüé≤ X√∫c x·∫Øc ƒë·ªï v·ªÅ x·ªâu\nüèÜ Ch√∫c m·ª´ng b·∫°n th·∫Øng c∆∞·ª£c"
                    this.SEND((seft.idChonXiu)[x]['IdTelegram'], Text)

                    user.GameHistoryUser((seft.idChonXiu)[x]['IdTelegram'])
                    user.DonCuocBanTaiXiu((seft.idChonXiu)[x]['IdTelegram'])
                }

            }
            if (seft.idChonTai != '') {
                for (var x in seft.idChonTai) {

                    // L∆∞u th·ªëng k√™ ng∆∞·ªùi ch∆°i
                    Sql = "SELECT * FROM thongkenguoichoi WHERE IdTelegram = ?"
                    conn.query(Sql, [(seft.idChonTai)[x]['IdTelegram']], function (err, data) {
                        if (err) throw err
                        if (data != '') {
                            var TongTienCuoc = Number(data[0]['TongTienCuoc']) + Number((seft.idChonTai)[x]['TienCuoc'])
                            var TongTienThangCuoc = Number(data[0]['TongTienThangCuoc']) + (0 - Number((seft.idChonTai)[x]['TienCuoc']))
                            var SoLanChoi = Number(data[0]['SoLanChoi']) + 1
                            Sql = "UPDATE thongkenguoichoi SET TongTienCuoc = ?, TongTienThangCuoc = ?, SoLanChoi = ? WHERE IdTelegram = ?"
                            conn.query(Sql, [TongTienCuoc, TongTienThangCuoc, SoLanChoi, (seft.idChonTai)[x]['IdTelegram']], function (err) {
                                if (err) throw err
                            })

                        }
                        else if (data == '') {
                            var TongTienCuoc = Number((seft.idChonTai)[x]['TienCuoc'])
                            var TongTienThangCuoc = 0 - Number((seft.idChonTai)[x]['TienCuoc'])
                            var SoLanChoi = 1
                            Sql = "INSERT INTO thongkenguoichoi (IdTelegram,Nickname,TongTienCuoc,TongTienThangCuoc,SoLanChoi) VALUES (?,?,?,?,?)"
                            conn.query(Sql, [
                                (seft.idChonTai)[x]['IdTelegram'],
                                (seft.idChonTai)[x]['Nickname'],
                                TongTienCuoc,
                                TongTienThangCuoc,
                                SoLanChoi
                            ],
                                function (err) {
                                    if (err) throw err
                                })

                        }

                    })

                    // X√≥a ƒë∆°n c∆∞·ª£c b√†n t√†i x·ªâu
                    Sql = "DELETE FROM doncuocbantaixiu WHERE IdTelegram = ?"
                    conn.query(Sql, [(seft.idChonTai)[x]['IdTelegram']], function (err) {
                        if (err) throw err
                    })



                    // L∆∞u l·ªãch s·ª≠ ch∆°i
                    Sql = "INSERT INTO gamehistory (TimeInit,IdTelegram,Nickname,TroChoi,DaChon,SoTien,KetQua,KetQua1,TraThuong,SaoKe,GhiChu) VALUES (?,?,?,?,?,?,?,?,?,?,?)"
                    conn.query(Sql, [
                        (seft.idChonTai)[x]['TimeInit'],
                        (seft.idChonTai)[x]['IdTelegram'],
                        (seft.idChonTai)[x]['Nickname'],
                        'B√†n T√†i X·ªâu',
                        (seft.idChonTai)[x]['Cau'],
                        (seft.idChonTai)[x]['TienCuoc'],
                        seft.ketQua.result,
                        'Losing',
                        (0 - Number((seft.idChonTai)[x]['TienCuoc'])),
                        Number(seft.idChonTai[x]['Vi']),
                        (String((seft.idChonTai)[x]['Cau']) + ' ' + String((seft.idChonTai)[x]['TienCuoc']))

                    ], function (err) {
                        if (err) throw err
                    })


                    // G·ª≠i t·ªõi tele
                    var Text = "LIXI66.TOP\n\nüéÆ Id phi√™n game: " + seft.idPhien + "\nüé≤ X√∫c x·∫Øc ƒë·ªï v·ªÅ x·ªâu\nüçÄ V√°n sau c√≥ th·ªÉ may m·∫Øn n√® !"
                    this.SEND((seft.idChonTai)[x]['IdTelegram'], Text)

                    user.GameHistoryUser((seft.idChonTai)[x]['IdTelegram'])
                    user.DonCuocBanTaiXiu((seft.idChonTai)[x]['IdTelegram'])
                }
            }

        }

        setTimeout(() => {
            // L∆∞u ƒëo·∫°n chat 
            var Mess = "K·∫øt th√∫c phi√™n !<br>Ch√∫c m·ª´ng nh·ªØng b·∫°n ƒë√£ ch·ªçn " + (seft.ketQua.result == 'tai' ? 'T√†i' : 'X·ªâu') + "<br>" + "X√∫c x·∫Øc: " + seft.ketQua.dice1 + " - " + seft.ketQua.dice2 + " - " + seft.ketQua.dice3 + " t·ªïng 3 x√∫c x·∫Øc: " + (seft.ketQua.dice1 + seft.ketQua.dice2 + seft.ketQua.dice3)
            Sql = "INSERT INTO chat (Nickname,TimeInit,IdNguoiGui,IdNguoiNhan,Mess) VALUES (?,?,?,?,?)"
            conn.query(Sql, ['', seft.TimeInit, 'System', 'All', Mess], function (err) {
                if (err) throw err
                user.SendChat()
            })
        }, 3000)

        user.GameHistory()
        loopAGame = setInterval(function () {
            seft.time--;
            console.log(seft.time);
            io.sockets.emit('gameData', {
                TimeInit: seft.TimeInit,
                idGame: seft.idPhien,
                soNguoiChonTai: seft.soNguoiChonTai,
                soNguoiChonXiu: seft.soNguoiChonXiu,
                tongTienDatTai: seft.tongTienDatTai,
                tongTienDatXiu: seft.tongTienDatXiu,
                time: seft.time,
                Msg: 'K·∫øt th√∫c phi√™n'
            });
            if (seft.time == 0) {
                clearInterval(loopAGame);
                seft.gameStart();
            }
        }, 1000);
    };


    // ƒê·∫∑t c∆∞·ª£c
    this.putMoney = function (TimeInit, IdTelegram, Nickname, Cau, TienCuoc, Vi, TiLe) {
        if (Cau == 'BT') {
            this.tongTienDatTai += Number(TienCuoc)
            // th√™m id v√†o list id array n·∫øu ch∆∞a c√≥
            if (!this.idChonTai.find(x => x.IdTelegram === IdTelegram)) {
                this.idChonTai.push({
                    TimeInit: TimeInit,
                    IdTelegram: IdTelegram,
                    Nickname: Nickname,
                    Cau: Cau,
                    TienCuoc: TienCuoc,
                    Vi: Vi,
                    TiLe: TiLe
                })
                this.soNguoiChonTai++;
            }
            else {
                // n·∫øu t√¨m th·∫•y th√¨ c·ªông th√™m ti·ªÅn v√¥
                this.idChonTai.find(x => x.IdTelegram === IdTelegram).TienCuoc += TienCuoc
            }
        }
        else {
            this.tongTienDatXiu += Number(TienCuoc)
            // th√™m id v√†o list id array n·∫øu ch∆∞a c√≥
            if (!this.idChonXiu.find(x => x.IdTelegram === IdTelegram)) {
                this.idChonXiu.push({
                    TimeInit: TimeInit,
                    IdTelegram: IdTelegram,
                    Nickname: Nickname,
                    Cau: Cau,
                    TienCuoc: TienCuoc,
                    Vi: Vi,
                    TiLe: TiLe
                })
                this.soNguoiChonXiu++;
            }
            else {
                // n·∫øu t√¨m th·∫•y th√¨ c·ªông th√™m ti·ªÅn v√¥
                this.idChonXiu.find(x => x.IdTelegram === IdTelegram).TienCuoc += TienCuoc
            }
        }
        return
    }

    // Thay ƒë·ªïi x√∫c x·∫Øc
    this.ThayDoiXucXac = (data) => {
        seft = this 
        seft.ketQua.dice1 = data.dice1
        seft.ketQua.dice2 = data.dice2
        seft.ketQua.dice3 = data.dice3
        seft.ketQua.result = data.dice1 + data.dice2 + data.dice3 <= 10 ? 'xiu' : 'tai'
        return
    }

    // random k·∫øt qu·∫£
    this.gameRandomResult = function () {
        dice1 = Math.floor(1 + Math.random() * (6));
        dice2 = Math.floor(1 + Math.random() * (6));
        dice3 = Math.floor(1 + Math.random() * (6));
        return {
            dice1: dice1,
            dice2: dice2,
            dice3: dice3,
            result: dice1 + dice2 + dice3 <= 10 ? 'xiu' : 'tai'
        };
    }

    // T·∫°o Id Phi√™n
    this.RandomNumber = function (length) {
        characters = '0123456789';
        result = '';
        charactersLength = characters.length;
        for (i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }

        return result;
    }

    // G·ª≠i tin nh·∫Øn bot tele
    this.SEND = function (IdTelegram, Text) {
        var url = 'https://api.telegram.org/bot' + encodeURI('6562374329:AAGpe0dZVpJzkMJf2LUVvg1zT-GytH02YQU') + '/sendMessage?chat_id=' + IdTelegram + '&text=' + encodeURI(Text);
        request.get(url);
        return
    }

}

const User = function () {

    // G·ª≠i chat t·ªõi client
    this.SendChat = () => {
        var Sql = "SELECT * FROM chat ORDER BY Id DESC LIMIT 50"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.sockets.emit('Msg', data.reverse())

        })

        return
    }


    // L·∫•y d·ªØ li·ªáu b√≥ng ƒë√° 
    this.FootballData = () => {
        var Sql = "SELECT * FROM keobongda ORDER BY Gio ASC"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.sockets.emit('FootballData', data.reverse())
        })

        return
    }

    // L·∫•y l·ªãch s·ª≠ ng∆∞·ªùi ch∆°i 
    this.GameHistoryUser = (IdTelegram) => {
        var Sql = "SELECT * FROM gamehistory WHERE IdTelegram = ? ORDER BY Id DESC LIMIT 15"
        conn.query(Sql, [IdTelegram], function (err, data) {
            if (err) throw err
            io.to(IdTelegram).emit('GameHistoryUser', data)
        })

        return
    }

    // L·∫•y l·ªãch s·ª≠ ch∆°i
    this.GameHistory = () => {
        var Sql = "SELECT * FROM gamehistory ORDER BY Id DESC LIMIT 10"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.sockets.emit('GameHistory', data)
        })

        return
    }

    // L·∫•y b·∫£ng top
    this.BangTop = () => {
        var Sql = "SELECT * FROM bangtop"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.sockets.emit('Top', data)
        })

        return
    }

    // L·∫•y danh s√°ch banking
    this.BankingList = (IdTelegram, List) => {
        if (List == 'Zalopay') {
            var Sql = "SELECT * FROM zalopaylist"
            conn.query(Sql, function (err, data) {
                if (err) throw err
                io.to(IdTelegram).emit('ZalopayList', data)
            })
            return
        }
        else if (List == 'Momo') {
            var Sql = "SELECT * FROM momolist"
            conn.query(Sql, function (err, data) {
                if (err) throw err
                io.to(IdTelegram).emit('MomoList', data)
            })
            return
        }
        var Sql = "SELECT * FROM bankinglist"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(IdTelegram).emit('BankingList', data)
        })
        return
    }


    // L·∫•y ƒë∆°n c∆∞·ª£c b√†n t√†i x·ªâu
    this.DonCuocBanTaiXiu = (IdTelegram) => {
        var Sql = "SELECT Cau,TienCuoc FROM doncuocbantaixiu WHERE IdTelegram = ?"
        conn.query(Sql, [IdTelegram], function (err, data) {
            if (err) throw err
            io.to(IdTelegram).emit('DonCuocBanTaiXiu', data)
        })
    }

    // Time Current
    this.TimeCurrent = () => {
        var date = new Date(Date.now())
        dateFormat = (String(date.getHours()).length == 1 ? ('0' + date.getHours()) : date.getHours()) + 'h' + ":" + (String(date.getMinutes()).length == 1 ? ('0' + date.getMinutes()) : date.getMinutes()) + 'm' + ", " + date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();
        return dateFormat;
    }
}

const Admin = function () {

    // Open File Json
    this.OpenFileJson = (PathFile) => {
        let File = path.join(__dirname, PathFile);
        File = fs.readFileSync(File, 'utf-8')
        return JSON.parse(File, true)
    }

    // H·ªá th·ªëng
    this.System = (TokenAdmin) => {

        // S·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i
        var Sql = "SELECT Id FROM user"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('SoLuongNguoiChoi', data.length)
        })

        // T·ªïng doanh thu
        var Sql = "SELECT TongTienThangCuoc FROM thongkenguoichoi"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            var TongTienThangCuoc = 0
            for (var x in data) {
                TongTienThangCuoc += (-Number(data[x]['TongTienThangCuoc']))
            }
            io.to(TokenAdmin).emit('TongDoanhThu', TongTienThangCuoc)
        })

        // Doanh thu game tele
        var Sql = "SELECT TongTienThangCuoc FROM thongkegametele"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            var TongTienThangCuoc = 0
            for (var x in data) {
                TongTienThangCuoc += (-Number(data[x]['TongTienThangCuoc']))
            }
            io.to(TokenAdmin).emit('DoanhThuGameTele', TongTienThangCuoc)
        })

        // Doanh thu game zalopay

        // Doanh thu game banking

        // Doanh thu game momo
        var Sql = "SELECT TongTienThangCuoc FROM thongkegamemomo"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            var TongTienThangCuoc = 0
            for (var x in data) {
                TongTienThangCuoc += Number(data[x]['TongTienThangCuoc'])
            }
            io.to(TokenAdmin).emit('DoanhThuGameMomo', TongTienThangCuoc)
        })

        // ƒê∆°n c∆∞·ª£c b√≥ng ƒë√°
        var Sql = "SELECT * FROM doncuocbongda"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('DonCuocBongDa', data.length)
        })
        // ƒê∆°n c∆∞·ª£c s·ªï x·ªë
        var Sql = "SELECT * FROM doncuocsoxo"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('DonCuocSoXo', data.length)
        })
        // File system
        var File = this.OpenFileJson('Public/Json/System.json')
        io.to(TokenAdmin).emit('File', File)

        return
    }

    // T√¨m ki·∫øm ng∆∞·ªùi ch∆°i
    this.TimKiemNguoiChoi = (TokenAdmin, Search) => {
        var Sql = "SELECT * FROM user WHERE IdTelegram = ? OR Nickname = ?"
        conn.query(Sql, [Search, Search], function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('TimKiemNguoiChoi', data)
        })
        return
    }

    // Qu·∫£n l√Ω ng∆∞·ªùi ch∆°i
    this.QuanLyNguoiChoi = (TokenAdmin) => {
        // L·∫•y danh s√°ch ng∆∞·ªùi ch∆°i
        var Sql = "SELECT * FROM user"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('DanhSachNguoiChoi', data)
        })
        // Th·ªëng k√™ ng∆∞·ªùi ch∆°i
        var Sql = "SELECT * FROM thongkenguoichoi"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('ThongKeNguoiChoi', data)
        })
        // L·∫•y danh blacklist
        var Sql = "SELECT * FROM blacklist"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('DanhSachBlackList', data)
        })
        // L·∫•y danh b·∫ª c·∫ßu
        var Sql = "SELECT * FROM becau"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('DanhSachBeCau', data)
        })
        // L·∫•y danh block spam
        var Sql = "SELECT * FROM blockspam"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('DanhSachBlockSpam', data)
        })
        // L·∫•y b·∫£ng top
        var Sql = "SELECT * FROM bangtop"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('BangTop', data)
            user.BangTop()
        })


        return
    }

    // Giftcode 
    this.Giftcode = (TokenAdmin) => {
        // L·∫•y b·∫£ng giftcode 
        var Sql = "SELECT * FROM giftcode"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('Giftcode', data)
        })

        // L·∫•y l·ªãch s·ª≠ gift code 
        var Sql = "SELECT * FROM giftcodehistory"
        conn.query(Sql, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('LichSuGiftCode', data)
        })

        return
    }

    // L·ªãch s·ª≠ game
    this.LichSuGame = (TokenAdmin) => {
        // L·∫•y l·ªãch s·ª≠ ch∆°i 
        var Query = "SELECT * FROM gamehistory ORDER BY Id DESC"
        conn.query(Query, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('LichSuChoi', data)
        })


        // L·∫•y l·ªãch s·ª≠ n·∫°p ti·ªÅn 
        var Query = "SELECT * FROM deposit_history ORDER BY Id DESC"
        conn.query(Query, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('LichSuNapTien', data)
        })

        // L·∫•y l·ªãch s·ª≠ r√∫t ti·ªÅn 
        var Query = "SELECT * FROM lichsuruttien ORDER BY Id DESC"
        conn.query(Query, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('LichSuRutTien', data)
        })

        return

    }

    // Game 
    this.Game = (TokenAdmin) => {
        // L·∫•y doanh thu game tele
        var Query = 'SELECT * FROM thongkegametele'
        conn.query(Query, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('ThongKeGameTele', data)
        })

        // L·∫•y ƒë∆°n c∆∞·ª£c s·ªï x·ªë
        var Query = 'SELECT * FROM doncuocsoxo'
        conn.query(Query, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('DonCuocSoXo', data)
        })

        // L·∫•y k√®o b√≥ng ƒë√° 
        var Query = "SELECT * FROM keobongda ORDER BY Gio ASC"
        conn.query(Query, function (err, data) {
            if (err) throw err
            if (data != "") {
                io.to(TokenAdmin).emit('KeoBongDa', data)
            }
        })

        // L·∫•y ƒë∆°n c∆∞·ª£c b√≥ng ƒë√° 
        var Query = "SELECT * FROM doncuocbongda"
        conn.query(Query, function (err, data) {
            if (err) throw err
            if (data != "") {
                io.to(TokenAdmin).emit('DonCuocBongDa', data)
            }
        })

        // L·∫•y Id ng∆∞·ªùi ch∆°i
        var Query = "SELECT IdTelegram,Nickname FROM user"
        conn.query(Query, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('IdTelegram', data)
        })

        // L·∫•y block chat
        var Query = "SELECT * FROM blockchat"
        conn.query(Query, function (err, data) {
            if (err) throw err
            io.to(TokenAdmin).emit('BlockChat', data)
        })

        return
    }

    this.Banking = (TokenAdmin) => {

        // L·∫•y danh s√°ch banking momo
        var Query = "SELECT * FROM momolist"
        conn.query(Query, function (err, data) {
            if (err) throw err
            if (data != '') {
                io.to(TokenAdmin).emit('Momo', data)
            }
        })

        // L·∫•y danh s√°ch zalo pay
        var Query = "SELECT * FROM zalopaylist"
        conn.query(Query, function (err, data) {
            if (err) throw err
            if (data != '') {
                io.to(TokenAdmin).emit('Zalopay', data)
            }
        })

        // L·∫•y danh s√°ch r√∫t ti·ªÅn 
        var Query = "SELECT * FROM lichsuruttien WHERE TrangThai = 'ƒêang x·ª≠ l√Ω'"
        conn.query(Query, function (err, data) {
            if (err) throw err
            if (data != '') {
                io.to(TokenAdmin).emit('LichSuRutTien', data)
            }
        })

        return

    }

}


var gameTaiXiu = new GameTaiXiu()
var user = new User()
var admin = new Admin()
gameTaiXiu.gameStart()



io.on("connection", (socket) => {


    socket.on("disconnecting", (reason) => {
        for (const room of socket.rooms) {
            if (room !== socket.id) {
                socket.leave(socket.id)
            }
        }
    });

    socket.on('JoinRoom', (data) => {
        socket.join(data);
    })

    socket.on('JoinAdmin', (data) => {
        socket.join(data);
    })

    // ƒê·∫∑t c∆∞·ª£c
    socket.on('DatCuoc', (data) => {
        gameTaiXiu.putMoney(data.TimeInit, data.IdTelegram, data.Nickname, data.Cau, data.TienCuoc, data.Vi, data.TiLe)
    })

    // Thay ƒë·ªïi x√∫c x·∫Øc
    socket.on('ThayDoiXucXac', (data) => {
        console.log(data)
        gameTaiXiu.ThayDoiXucXac(data);
    })

    // Y√™u c·∫ßu ƒë∆°n c∆∞·ª£c b√†n t√†i x·ªâu
    socket.on('DonCuocBanTaiXiu', (data) => {
        user.DonCuocBanTaiXiu(data)
    })

    // Y√™u c·∫ßu chat
    socket.on('ReqChat', () => {
        user.SendChat()
    })

    // Y√™u c·∫ßu d·ªØ li·ªáu b√≥ng ƒë√°
    socket.on('KeoBongDa', () => {
        user.FootballData()
    })

    // Y√™u c·∫ßu danh s√°ch banking
    socket.on('BankingList', (data) => {
        user.BankingList(data[0], data[1])
    })

    // Y√™u c·∫ßu l·ªãch s·ª≠ ch∆°i c·ªßa ng∆∞·ªùi ch∆°i
    socket.on('GameHistoryUser', (data) => {
        user.GameHistoryUser(data)
    })

    // Y√™u c·∫ßu l·ªãch s·ª≠ ch∆°i 
    socket.on('GameHistory', (data) => {
        user.GameHistory(data)
    })

    // Y√™u c·∫ßu Top
    socket.on('Top', () => {
        user.BangTop()
    })

    // H·ªá th·ªëng
    socket.on('System', (data) => {
        admin.System(data)
    })

    // T√¨m ki·∫øm ng∆∞·ªùi ch∆°i
    socket.on('TimKiemNguoiChoi', (data) => {
        admin.TimKiemNguoiChoi(data[0], data[1]);
    })

    // Qu·∫£n l√Ω ng∆∞·ªùi ch∆°i
    socket.on('QuanLyNguoiChoi', (data) => {
        admin.QuanLyNguoiChoi(data)
    })

    // Gift code 
    socket.on('Giftcode', (data) => {
        admin.Giftcode(data)
    })

    // L·ªãch s·ª≠ game
    socket.on('LichSuGame', (data) => {
        admin.LichSuGame(data)
    })

    // Game 
    socket.on('Game', (data) => {
        admin.Game(data)
    })

    // Banking
    socket.on('Banking', (data) => {
        admin.Banking(data);
    })

})

httpServer.listen(port, () => {
    console.log('Listen on port ' + port)
})